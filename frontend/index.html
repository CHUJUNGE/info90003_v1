<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crime Scene Reconstruction</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&family=Audiowide&family=Exo+2:wght@400;700&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script> <!-- Three.js CDN -->
</head>
<body>
    <div class="container">
        <div class="scene-container">
            <!-- Three.js canvas will be appended here by globe.js -->
            <h1 class="title">Crime Scene Reconstruction Device</h1>
        </div>

        <button id="fullscreen-btn" title="Toggle Fullscreen">
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
            </svg>
        </button>

        <!-- ESP32 Connection Modal -->
        <div id="esp32-connect-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="close-modal-btn">&times;</span>
                <h2>Connect to ESP32</h2>
                <label for="esp32-ip">ESP32 IP Address:</label>
                <input type="text" id="esp32-ip" name="esp32-ip" value="crimescene.local">
                <button id="connect-esp32-btn">Connect</button>
                <p id="esp32-modal-status">Status: Idle</p>
            </div>
        </div>

        <!-- ESP32 Connection Status Indicator (Bottom Left) -->
        <div id="esp32-status-indicator">
            <span>ESP32: </span><span id="esp32-status-text">Disconnected</span>
        </div>

        <!-- Stage elements container -->
        <div id="stage-elements-container">
            <!-- Stage 0 elements (like the globe canvas) are already here or dynamically added -->
            <div id="stage1-welcome-message" class="stage-message" style="display: none;">Welcome</div>
            <!-- Stage 2 elements -->
            <div id="stage2-container" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                <h2 id="stage2-title" class="stage-title" style="opacity: 0; transition: opacity 1s ease-in;">Case 001: A woman was found dead in her home</h2>
                <div style="position: relative; width: 100%; height: 100%; overflow: hidden;">
                    <canvas id="floorplan-canvas" style="width: 100%; height: 100%; position: relative; left: -15%;"></canvas>
                </div>
                
                <!-- Scan instruction image and text -->
                <div id="scan-instruction" style="position: absolute; right: 30px; bottom: 30px; text-align: center; opacity: 0; transition: opacity 1s ease-in;">
                    <img src="assets/picture/scan_instructor.png" alt="Scan Instructor" style="max-width: 300px; display: block; margin: 0 auto;">
                    <p class="scan-text">Scan the evidence to uncover the truth</p>
                </div>
            </div>
            <!-- Stage 3-1: RFID Scan Result for Cup -->
            <div id="stage3-1-container" class="stage-message" style="display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
                <video id="rfid-scan-video" width="70%" height="auto" style="max-width: 800px; margin-bottom: 20px; border: 2px solid #00ff00;">
                    <source src="assets/videos/cup_scan.mp4" type="video/mp4">
                    您的浏览器不支持HTML5视频。
                </video>
                <p id="rfid-scan-message" style="font-size: 1.8em; color: #00ff00; text-shadow: 0 0 7px #00ff00, 0 0 10px #00ff00;"></p>
                <img id="wife-image" src="assets/picture/wife.png" alt="Wife's Picture" style="display: none;">
            </div>
            <!-- Stage 4-1: Cup Movement Video -->
            <div id="stage4-1-container" class="stage-message" style="display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
                <div style="position: relative; width: 70%; max-width: 800px;">
                    <video id="cup-movement-video" width="100%" height="auto" style="margin-bottom: 20px; border: 2px solid #00ff00;" loop>
                        <source src="assets/videos/cup_movement.mp4" type="video/mp4">
                        您的浏览器不支持HTML5视频。
                    </video>
                    <div id="countdown-timer" style="position: absolute; top: 10px; right: 10px; font-size: 2.5em; color: #00ccff; font-weight: bold; text-shadow: 0 0 8px #0066ff; font-family: Arial, sans-serif; letter-spacing: 0px; display: none; border: 1px solid #00ccff; border-radius: 5px; padding: 2px 10px; background-color: rgba(0,10,20,0.7);">6</div>
                </div>
                <p id="cup-movement-message" style="font-size: 0.4em; color: #0091ff; text-shadow: 0 0 2px #00ccff;">Please try to perform the action to verify the action logic</p>
            </div>
            <!-- Stage 4-1-1: Action Reproduction Prompt -->
            <div id="stage4-1-1-container" class="stage-message" style="display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100%;">
                <p id="action-reproduction-message" style="font-size: 1em; color: #00ccff; text-shadow: 0 0 10px #0066ff; font-family: Arial, sans-serif;">Please reproduce the action</p>
            </div>
        </div>

        <!-- Audio element for stage-specific sounds -->
        <audio id="stage-audio" loop preload="auto"></audio>

        <!-- Scripts -->
        <script type="module" src="js/globe.js"></script>
        <script src="js/esp32.js"></script> <!-- Ensure this is included -->
        <script src="js/AudioManager.js"></script> <!-- Include AudioManager -->
        <script src="js/3d-floorplan.js"></script> <!-- Include 3D Floorplan -->
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script> <!-- Socket.IO Client for RFID -->
        <script type="module"> 
            let audioManager; 
            let isTransitioningToStage1 = false; // Flag to prevent multiple transitions
            let currentStage = 'stage0'; // Initialize current application stage

            document.addEventListener('DOMContentLoaded', () => {
                const modal = document.getElementById('esp32-connect-modal');
                const closeModalBtn = document.getElementById('close-modal-btn');
                const connectEsp32Btn = document.getElementById('connect-esp32-btn');
                const esp32IpInput = document.getElementById('esp32-ip');
                const modalStatus = document.getElementById('esp32-modal-status');
                const statusIndicator = document.getElementById('esp32-status-indicator');
                const statusText = document.getElementById('esp32-status-text');

                let esp32Connection = null;
            let rfidSocket = null; // Socket.IO connection for RFID backend 

                // Initialize AudioManager - assign to the higher-scoped variable
                audioManager = new AudioManager(); 
                audioManager.loadSound('stage0Music', 'assets/audio/stage0.wav', true);
                // Preload Stage 1 sounds
                audioManager.loadSound('stage1WelcomeSFX', 'assets/audio/stage1_welcome_sfx.wav', false);
                audioManager.loadSound('stage1WelcomeVoiceZH', 'assets/audio/stage1_welcome_voice_zh.mp3', false);
                audioManager.loadSound('scanningSFX', 'assets/audio/scanning.wav', false);
                audioManager.loadSound('cupScanAudio', 'assets/audio/cup_scan.mp3', false);
                audioManager.loadSound('victimBioAudio', 'assets/audio/victim_biological.mp3', false);
                audioManager.loadSound('cupMovementAudio', 'assets/audio/cup_scan.mp3', false); // 复用 cup_scan.mp3 作为 cup_movement.mp4 的音频
                audioManager.loadSound('countdownBeeping', 'assets/audio/countdown_beeping.wav', false);

                // Attempt to play Stage 0 music. If audio not unlocked, it will be queued and play on first interaction.
                if (audioManager) { 
                    console.log('DOMContentLoaded: audioManager instance available, setting stage0Music.');
                    audioManager.setStageMusic('stage0Music'); 
                } else {
                    console.error('DOMContentLoaded: audioManager is NOT available here!');
                }

                const titleElement = document.querySelector('.title'); 
                const stage1WelcomeMessage = document.getElementById('stage1-welcome-message'); // Get Stage 1 Welcome message

                // Make Stage 0 elements visible
                if (titleElement) {
                    titleElement.classList.add('flicker-effect'); 
                }

                // Function to update UI based on connection state
                function updateUI(state, message = '') {
                    statusIndicator.classList.add('visible');
                    switch (state) {
                        case 'connecting':
                            modalStatus.textContent = `Status: Connecting to ${esp32IpInput.value}... ${message}`;
                            statusText.textContent = 'Connecting...';
                            statusText.className = 'connecting';
                            connectEsp32Btn.disabled = true;
                            connectEsp32Btn.textContent = 'Connecting...';
                            break;
                        case 'connected':
                            modalStatus.textContent = `Status: Connected to ${esp32IpInput.value}!`;
                            statusText.textContent = 'Connected';
                            statusText.className = 'connected';
                            connectEsp32Btn.disabled = false;
                            connectEsp32Btn.textContent = 'Disconnect'; 
                            modal.style.display = 'none'; 
                            break;
                        case 'disconnected':
                            modalStatus.textContent = `Status: Disconnected. ${message}`;
                            statusText.textContent = 'Disconnected';
                            statusText.className = 'disconnected';
                            connectEsp32Btn.disabled = false;
                            connectEsp32Btn.textContent = 'Connect';
                            break;
                        case 'error':
                            modalStatus.textContent = `Status: Error. ${message}`;
                            statusText.textContent = 'Error';
                            statusText.className = 'disconnected'; 
                            connectEsp32Btn.disabled = false;
                            connectEsp32Btn.textContent = 'Connect';
                            break;
                        default: 
                            modalStatus.textContent = 'Status: Idle. Press Space to toggle.';
                            statusText.textContent = 'Disconnected';
                            statusText.className = 'disconnected';
                            statusIndicator.classList.remove('visible'); 
                    }
                }

                // Show modal by default
                modal.style.display = 'block';
                updateUI('idle');

                closeModalBtn.onclick = () => {
                    modal.style.display = 'none';
                }

                window.onclick = (event) => {
                    if (event.target == modal) {
                        // modal.style.display = 'none'; 
                    }
                }

                document.addEventListener('keydown', (event) => {
                    if (event.code === 'Space') {
                        event.preventDefault(); 
                        if (modal.style.display === 'block') {
                            modal.style.display = 'none';
                        } else {
                            modal.style.display = 'block';
                        }
                        // Update status in modal if shown
                        if (esp32Connection && esp32Connection.isConnected) {
                            updateUI('connected');
                        } else if (esp32Connection && connectEsp32Btn.disabled) { 
                            updateUI('connecting', modalStatus.textContent.replace('Status: ', ''));
                        }
                        else {
                            updateUI('disconnected', modalStatus.textContent.replace('Status: ', ''));
                        }
                    }
                });

                connectEsp32Btn.addEventListener('click', () => {
                    const ipAddress = esp32IpInput.value.trim();
                    if (!ipAddress) {
                        alert('Please enter an ESP32 IP address.');
                        return;
                    }

                    if (esp32Connection && esp32Connection.isConnected) {
                        esp32Connection.disconnect();
                    } else {
                        if (esp32Connection) { 
                            esp32Connection.disconnect(); 
                        }
                        updateUI('connecting'); // Moved updateUI call to before creating new connection
                        esp32Connection = new ESP32Connection(ipAddress);

                        esp32Connection.onConnect(() => {
                            updateUI('connected');
                            console.log('已连接到ESP32。'); 

                            // If current stage is 'stage0' and connection is established, set LED to blue
                            if (currentStage === 'stage0' && esp32Connection && esp32Connection.isConnected) {
                                esp32Connection.sendCommand("setLedMode", { mode: 2 }); // 2 corresponds to blue solid light
                                console.log('Sent command to ESP32 via sendCommand: setLedMode to blue for stage0.');
                            }
                        });

                        esp32Connection.onDisconnect((event) => {
                            let message = event && event.reason ? event.reason : '连接丢失或失败。';
                            if(event && event.code === 1000 && event.reason === '主动断开') { 
                                message = "用户主动断开连接。";
                            } else if (esp32Connection && esp32Connection.reconnectAttempts >= esp32Connection.maxReconnectAttempts) {
                                message = "多次尝试后连接失败。";
                            }
                            updateUI('disconnected', message);
                            console.log(`与ESP32断开连接: ${message}`); 
                        });
                        
                        esp32Connection.onData((data) => {
                            console.log('从ESP32接收到数据:', data); 

                            // Future: if ESP32 sends stage changes, call audioManager.setStageMusic() or similar
                        });

                        // Directly call connect, removing the problematic if condition
                        esp32Connection.connect();
                    }
                });

                // Listen for key presses for stage transitions
                document.addEventListener('keyup', (event) => {
                    const titleElement = document.querySelector('.title'); 
                    const stage1WelcomeMessage = document.getElementById('stage1-welcome-message');

                    if (event.key === '1' && !isTransitioningToStage1) { // Check the flag here
                        isTransitioningToStage1 = true; // Set the flag
                        console.log('Key 1 pressed: Transitioning to Stage 1 (flag set)');
                        console.log('Keyup event: Checking audioManager instance:', audioManager);
                        
                        // 1. Stop Stage 0 music & Start Stage 0 elements disappearing
                        if (audioManager) {
                            console.log('Keyup event: audioManager is available, attempting to stop music and play SFX.');
                            audioManager.setStageMusic(null); // Stop stage 0 music
                        } else {
                            console.error('Keyup event: audioManager is NOT available here! Cannot stop music or play SFX.');
                        }
                        
                        if (titleElement) {
                            titleElement.classList.remove('flicker-effect'); 
                            titleElement.style.opacity = '0';
                            titleElement.style.pointerEvents = 'none';
                        }

                        if (window.currentGlobe && typeof window.currentGlobe.dissipate === 'function') {
                            window.currentGlobe.dissipate(); // Start globe dissipation
                        }

                        // 2. Play transition SFX
                        if (audioManager) { // Check again for playing SFX
                            audioManager.playSound('stage1WelcomeSFX');
                        }

                        // 3. Delayed fade-in for Stage 1 Welcome message
                        if (stage1WelcomeMessage) {
                            // Ensure it's ready for transition (display block, opacity 0)
                            stage1WelcomeMessage.style.display = 'block'; // Or 'flex' etc. depending on desired layout. It uses .stage-message class with opacity 0.
                            // Add flicker effect if desired for stage 1 welcome, otherwise skip.
                            // stage1WelcomeMessage.classList.add('flicker-effect'); 
                            
                            // Delay the fade-in to allow SFX to play or Stage 0 elements to disappear
                            setTimeout(() => {
                                requestAnimationFrame(() => { // Ensure display change is processed before opacity transition
                                    stage1WelcomeMessage.style.opacity = '1';
                                    stage1WelcomeMessage.style.pointerEvents = 'auto';
                                });

                                // 4. Play welcome voice after Stage 1 Welcome message transition ends
                                stage1WelcomeMessage.addEventListener('transitionend', function onTransitionEnd() {
                                    if (audioManager) { // Check again for playing voice
                                        audioManager.playSound('stage1WelcomeVoiceZH');
                                        
                                        // Add event listener for when the welcome voice ends
                                        const stage1WelcomeVoice = audioManager.sounds['stage1WelcomeVoiceZH'].element;
                                        stage1WelcomeVoice.addEventListener('ended', function onVoiceEnded() {
                                            console.log('Stage 1 welcome voice ended, waiting 3s before transitioning to Stage 2');
                                            
                                            // Wait 3 seconds before transitioning to Stage 2
                                            setTimeout(() => {
                                                transitionToStage2();
                                            }, 3000);
                                            
                                            // Remove the event listener to prevent memory leaks
                                            stage1WelcomeVoice.removeEventListener('ended', onVoiceEnded);
                                        }, { once: true });
                                    }
                                    // Optional: Play Stage 1 music here
                                    // if (window.audioManager) {
                                    //     window.audioManager.setStageMusic('stage1Music'); // Assuming 'stage1Music' is loaded
                                    // }
                                    stage1WelcomeMessage.removeEventListener('transitionend', onTransitionEnd); // Clean up listener
                                }, { once: true }); // Ensure listener fires only once

                            }, 1000); // Adjust delay (in ms) as needed. E.g., 1000ms = 1 second
                        }
                    } else if (event.key === '1' && isTransitioningToStage1) {
                        console.log('Key 1 pressed, but already transitioning to Stage 1. Ignoring.');
                    }
                    // Add other stage transitions here (e.g., else if (event.key === '2'))
                });

                function initializeRfidConnection() {
                    if (rfidSocket && rfidSocket.connected) {
                        console.log('RFID connection already initialized and connected.');
                        // If already connected, ensure scanning is (re)started if appropriate for current stage
                        if (currentStage === 'stage2') { // Or other relevant stages
                            console.log('Requesting backend to START RFID scan (already connected).');
                            rfidSocket.emit('start_rfid_scan');
                        }
                        return; 
                    }

                    console.log('Initializing RFID connection for Stage 2 onwards...');
                    rfidSocket = io(); 

                    rfidSocket.on('connect', () => {
                        console.log('Connected to RFID backend server (main_server.py) - Stage 2 onwards.');
                        console.log('Requesting backend to START RFID scan (on connect).');
                        rfidSocket.emit('start_rfid_scan');
                    });

                    rfidSocket.on('disconnect', () => {
                        console.log('Disconnected from RFID backend server.');
                    });

                    rfidSocket.on('rfid_data', (data) => {
                        console.log('RFID data received from backend:', data);
                        console.log('Checking for cup: currentStage is', currentStage, 'data.name is', data.name); 
                        if (data.name === 'cup' && currentStage === 'stage2') { 
                            console.log('"Cup" tag detected! Transitioning to Stage 3-1.');
                            if (rfidSocket && rfidSocket.connected) {
                               rfidSocket.emit('stop_rfid_scan'); 
                            }
                            const rfidScanMessageEl = document.getElementById('rfid-scan-message');
                            if (rfidScanMessageEl && data.message_en) {
                                rfidScanMessageEl.textContent = data.message_en;
                            }
                            audioManager.playSound('scanningSFX');
                            transitionToStage3_1();
                        } else if (data.tag_id) {
                            console.log('Another tag detected:', data.tag_id);
                        } else if (data.message === "No tag found"){
                            console.log('Backend reports: No tag found in this scan attempt.');
                        }
                    });

                    rfidSocket.on('rfid_error', (error) => {
                        console.error('RFID Error from backend:', error.message);
                    });

                    rfidSocket.on('rfid_scan_stopped', (data) => {
                        console.log('RFID scanning has been stopped by the backend.', data ? data.message : '');
                    });
                }
                
                // Function to transition from Stage 1 to Stage 2
                function transitionToStage2() {
                    console.log('Transitioning to Stage 2');
                    currentStage = 'stage2'; // Update current stage

                    const stage1WelcomeMessage = document.getElementById('stage1-welcome-message');
                    const stage2Container = document.getElementById('stage2-container');
                    const stage2Title = document.getElementById('stage2-title');
                    
                    // 1. Fade out Stage 1 welcome message
                    if (stage1WelcomeMessage) {
                        stage1WelcomeMessage.style.opacity = '0';
                        
                        // Wait for fade out to complete
                        stage1WelcomeMessage.addEventListener('transitionend', function onStage1FadeOut() {
                            // Hide Stage 1 elements completely
                            stage1WelcomeMessage.style.display = 'none';
                            
                            // Stage 2 transition (no sound effect)
                            
                            // 3. Show Stage 2 container
                            if (stage2Container) {
                                stage2Container.style.display = 'block';
                                
                                // Initialize 3D floorplan
                                const floorplanRenderer = new FloorplanRenderer3D('floorplan-canvas');
                                floorplanRenderer.init();
                                floorplanRenderer.createFloorplan();
                                floorplanRenderer.createFloor();
                                floorplanRenderer.createWalls();
                                floorplanRenderer.createFurniture();
                                floorplanRenderer.createDecorations();
                                floorplanRenderer.createEvidenceMarkers();
                                floorplanRenderer.startAnimation();
                                floorplanRenderer.show();
                                
                                // Store the renderer in window for later access
                                window.floorplanRenderer = floorplanRenderer;
                                
                                // 4. Fade in Stage 2 title and scan instruction
                                setTimeout(() => {
                                    if (stage2Title) stage2Title.style.opacity = '1';
                                    
                                    // Show scan instruction after title appears
                                    setTimeout(() => {
                                        const scanInstruction = document.getElementById('scan-instruction');
                                        if (scanInstruction) scanInstruction.style.opacity = '1';
                                    }, 1000);
                                    
                                    // No background music for Stage 2

                                    // Initialize RFID and start scanning when Stage 2 is fully ready
                                    initializeRfidConnection();
                                    }, 1000);
                                }
                            
                                // Remove event listener
                                stage1WelcomeMessage.removeEventListener('transitionend', onStage1FadeOut);
                            }, { once: true });
                        }
                    }
                }); // END of transitionToStage2 function's event listener logic, BEFORE new function definition

                // Function to transition to Stage 3-1 (Cup Scan)
                function transitionToStage3_1() {
                    console.log('Transitioning to Stage 3-1 for Cup Scan');
                    const stage2Container = document.getElementById('stage2-container');
                    const stage3_1Container = document.getElementById('stage3-1-container');
                    const rfidScanVideo = document.getElementById('rfid-scan-video');
                    const rfidScanMessage = document.getElementById('rfid-scan-message');

                    // 1. Fade out Stage 2 elements
                    if (stage2Container) {
                        stage2Container.style.opacity = '0';
                        if (window.floorplanRenderer && typeof window.floorplanRenderer.stopAnimation === 'function') {
                            window.floorplanRenderer.stopAnimation(); // Stop 3D rendering
                        }
                        // After fade out, hide it to prevent interaction
                        stage2Container.addEventListener('transitionend', function onStage2FadeOut() {
                            stage2Container.style.display = 'none';
                            stage2Container.removeEventListener('transitionend', onStage2FadeOut);
                        }, { once: true });
                    }

                    // 2. Prepare and show Stage 3-1 elements
                    if (stage3_1Container && rfidScanVideo && rfidScanMessage) {
                        // rfidScanMessage.textContent = '证物-cup正在被扫描.'; // Message is now set by rfid_data listener
                        stage3_1Container.style.display = 'flex'; // Use flex for centering (as per new HTML structure)
                        
                        // Ensure display is set before starting opacity transition (critical for some browsers)
                        requestAnimationFrame(() => {
                            stage3_1Container.style.opacity = '1';
                            console.log('DEBUG: rfid-scan-message in transitionToStage3_1 - textContent:', rfidScanMessage.textContent, 'offsetHeight:', rfidScanMessage.offsetHeight); // DEBUG LINE
                            rfidScanVideo.currentTime = 0; // Rewind video to start
                            rfidScanVideo.play().catch(error => {
                                console.error("Video play failed:", error);
                            }); // End of video.play().catch()
                            audioManager.playSound('cupScanAudio');

                            rfidScanVideo.onended = () => {
                                console.log('Cup scan video finished.');
                                rfidScanVideo.style.display = 'none'; // Hide video
                                const wifeImage = document.getElementById('wife-image');
                                if (wifeImage) {
                                    wifeImage.style.display = 'block'; // Show image
                                    wifeImage.classList.add('glitch-image-effect'); // Add glitch effect
                                }
                                audioManager.stopSound('cupScanAudio'); // Stop previous audio
                                audioManager.playSound('victimBioAudio'); // Play new audio
                                
                                // Listen for victimBioAudio ended event
                                const victimBioAudioElement = audioManager.sounds['victimBioAudio'].element;
                                victimBioAudioElement.addEventListener('ended', function onVictimBioAudioEnded() {
                                    console.log('Victim biological audio ended, waiting 2s before transitioning to Stage 4-1');
                                    
                                    // Wait 2 seconds before transitioning to Stage 4-1
                                    setTimeout(() => {
                                        transitionToStage4_1();
                                    }, 2000);
                                    
                                    // Remove the event listener to prevent memory leaks
                                    victimBioAudioElement.removeEventListener('ended', onVictimBioAudioEnded);
                                }, { once: true });
                            };
                        }); // End of requestAnimationFrame callback
                            // Example: Fade out Stage 3-1 after video
                            // setTimeout(() => {
                            //    stage3_1Container.style.opacity = '0';
                            //    stage3_1Container.addEventListener('transitionend', () => stage3_1Container.style.display = 'none', { once: true });
                            // }, 1000); // Delay before fading out
                    } else {
                        console.error('Stage 3-1 elements not found!');
                    }
                }

                // Function to transition to Stage 4-1 (Cup Movement)
                function transitionToStage4_1() {
                    console.log('Transitioning to Stage 4-1 for Cup Movement');
                    const stage3_1Container = document.getElementById('stage3-1-container');
                    const stage4_1Container = document.getElementById('stage4-1-container');
                    const cupMovementVideo = document.getElementById('cup-movement-video');
                    const cupMovementMessage = document.getElementById('cup-movement-message');

                    // 1. Fade out Stage 3-1 elements
                    if (stage3_1Container) {
                        stage3_1Container.style.opacity = '0';
                        // After fade out, hide it to prevent interaction
                        stage3_1Container.addEventListener('transitionend', function onStage3_1FadeOut() {
                            stage3_1Container.style.display = 'none';
                            stage3_1Container.removeEventListener('transitionend', onStage3_1FadeOut);
                        }, { once: true });
                    }

                    // 2. Prepare and show Stage 4-1 elements
                    if (stage4_1Container && cupMovementVideo && cupMovementMessage) {
                        stage4_1Container.style.display = 'flex'; // Use flex for centering
                        
                        // Ensure display is set before starting opacity transition
                        requestAnimationFrame(() => {
                            stage4_1Container.style.opacity = '1';
                            cupMovementVideo.currentTime = 0; // Rewind video to start
                            cupMovementVideo.play().catch(error => {
                                console.error("Cup movement video play failed:", error);
                            });
                            // 不播放音频，让视频静音播放

                            // 在视频播放 3 秒后显示倒计时并播放音频
                            setTimeout(() => {
                                const countdownTimer = document.getElementById('countdown-timer');
                                if (countdownTimer) {
                                    countdownTimer.style.display = 'block';
                                    let countdown = 6;
                                    countdownTimer.textContent = countdown;
                                    
                                    // 播放倒计时音频
                                    audioManager.playSound('countdownBeeping');
                                    
                                    // 获取倒计时音频元素
                                    const countdownAudio = audioManager.sounds['countdownBeeping'].element;
                                    
                                    // 监听倒计时音频结束事件
                                    countdownAudio.addEventListener('ended', () => {
                                        console.log('Countdown audio ended, transitioning to stage4-1-1');
                                        // 停止视频循环播放
                                        cupMovementVideo.loop = false;
                                        // 过渡到 stage4-1-1
                                        transitionToStage4_1_1();
                                    }, { once: true });
                                    
                                    // 倒计时定时器
                                    const countdownInterval = setInterval(() => {
                                        countdown--;
                                        if (countdown <= 0) {
                                            clearInterval(countdownInterval);
                                            countdownTimer.style.display = 'none';
                                            // 倒计时结束后的操作（如果需要）
                                        } else {
                                            countdownTimer.textContent = countdown;
                                        }
                                    }, 1000);
                                }
                            }, 3000);

                            cupMovementVideo.onended = () => {
                                console.log('Cup movement video finished.');
                                // Optional: Define what happens after cup movement video ends
                                // For example, transition to another stage or show additional information
                            };
                        }); // End of requestAnimationFrame callback
                    } else {
                        console.error('Stage 4-1 elements not found!');
                    }
                }

                // Function to transition to Stage 4-1-1 (Action Reproduction Prompt)
                function transitionToStage4_1_1() {
                    console.log('Transitioning to Stage 4-1-1 for Action Reproduction');
                    const stage4_1Container = document.getElementById('stage4-1-container');
                    const stage4_1_1Container = document.getElementById('stage4-1-1-container');

                    // 1. Fade out Stage 4-1 elements
                    if (stage4_1Container) {
                        stage4_1Container.style.opacity = '0';
                        // After fade out, hide it to prevent interaction
                        stage4_1Container.addEventListener('transitionend', function onStage4_1FadeOut() {
                            stage4_1Container.style.display = 'none';
                            stage4_1Container.removeEventListener('transitionend', onStage4_1FadeOut);
                        }, { once: true });
                    }

                    // 2. Prepare and show Stage 4-1-1 elements
                    if (stage4_1_1Container) {
                        stage4_1_1Container.style.display = 'flex'; // Use flex for centering
                        
                        // Ensure display is set before starting opacity transition
                        requestAnimationFrame(() => {
                            stage4_1_1Container.style.opacity = '1';
                        });
                    } else {
                        console.error('Stage 4-1-1 elements not found!');
                    }
                }

            // Set initial stage music via AudioManager
            // This ensures audioManager is initialized before being used by keydown listener
            // which might fire before DOMContentLoaded if script is deferred or something similar (though unlikely here)
            if (audioManager) { // Check if audioManager is initialized
                audioManager.setStageMusic('stage0Music');
            }
        </script>
    </body>
</html>
